<html>
<head>
<link rel="stylesheet" type="text/css" href="ComplaintForm.css">
<link rel="stylesheet" type="text/css" href="databaseDisplay.css">
<script src="jquery-3.1.1.min.js"></script>
<script src="ComplaintForm.js"></script>
<script src="ContextMenu.js"></script>
<script src="DatabaseRow.js"></script>
<script>
  localStorage.removeItem("lastFormData"); 
	
	function dressUpColumnVal(val){
		var returnString = "";
		var breakPoint = val.search(/[A-Z]/);
		if(breakPoint != -1){
			returnString = val.slice(0,breakPoint);
		}
	}
	
	function makeFilter(column,value){
		var filter = "<span class='filterButton'>"+
	}
	
	function sortRows(column,dir = "asc"){
		var retVal;
		
		if(dir == "desc")
			retVal = 1;
		else if(dir == "asc")
			retVal = -1;
			
		if(column == "prefixAndCaseNumber"){
			rowObjects.sort(function(a,b){
			
			var aVal = parseInt(a.getCellValue("prefix")+a.getCellValue("caseNumber"));
			var bVal = parseInt(b.getCellValue("prefix")+b.getCellValue("caseNumber"));
			
			if(aVal < bVal)
				return retVal;
			else
				return -retVal;
		});
	}
	else if(column == "hearingDate"){
			rowObjects.sort(function(a,b){
				var aVal = parseInt(a.getCellValue(column).replace(/[^0-9]/g,""));
				var bVal = parseInt(b.getCellValue(column).replace(/[^0-9]/g,""));
				
				if(isNaN(aVal))
					aVal = 0;
				if(isNaN(bVal))
					bVal = 0;
				
				console.log("A AND B", aVal, bVal);
				
				if(aVal < bVal)
					return retVal;
				else
					return -retVal;
		});
	}
	else if(column == "plaintiff" || column == "witness"){
		rowObjects.sort(function(a,b){
			var aVal = a.getCellValue(column).toLowerCase().split(", ");
			aVal.sort();
			aVal = aVal.join("");
			
			var bVal = b.getCellValue(column).toLowerCase().split(", ");
			bVal.sort();
			bVal = bVal.join("");
			
			if(aVal < bVal)
				return retVal;
			else
				return -retVal;
		});
	}
	else{
		rowObjects.sort(function(a,b){
			if(a.getCellValue(column).toLowerCase() < b.getCellValue(column).toLowerCase())
				return retVal;
			else
				return -retVal;
		});
	}
}
	
	function makeTable(dataSet){
		var returnArray = [];
		
		for(let i = 0; i < dataSet.length; i++){
				returnArray.push(new DatabaseRow(dataSet[i],returnArray));
			}
			
		return returnArray;	
	}
	
	function fillTable(table){
		while(table.rows.length > 0)
			table.deleteRow(-1);
			
			for(let i = 0; i < rowObjects.length; i++){
				$(table).append(rowObjects[i].returnRow());
			}
	}
	
	
	var dbSearchCritera = {};
												 
	var columnIndex = {"prefixAndCaseNumber":0,"plaintiff":1,"defendant":2,"witness":3,"charge":4,"status":5,"hearingDate":6,"verdict":7,"sentence":8,"sentenceStatus":9};
	
var dataSet = [];
var rowObjects = [];

var upArrow = $("<span class='arrow up'>&#x25B2;</span>");
var downArrow = $("<span class='arrow down'>&#x25BC;</span>");

function getDBInfo(criteria = "all"){
			if(typeof criteria == "object"){
				if(Object.keys(criteria).length == 0)
					criteria = "all"
			}
			
			$.ajax({url:"./returnDBInfo.php",
			method: "GET",
			data:{"criteria": JSON.stringify(criteria)}, 
			success: function(result){
	    console.log(result);
			dataSet = JSON.parse(result);
			rowObjects = makeTable(dataSet);
			fillTable(mainTable.tBodies[0]);
		}});
}

 function  simpleHeadingMenuSetup(column){
 
	var searchFunc = function(cMenuDiv,target){
		toggleTextField(cMenuDiv.children(":contains('Search')"),"input",
		function(value){
			cMenuDiv.hide();
			dbSearchCritera[column] = value;
			getDBInfo(dbSearchCritera);
		});
	}
 
 var options = [["Search", searchFunc],
								["Sort By"],["asc",function(cMenuDiv){
																					cMenuDiv.hide();
																					$(".arrow").remove();
																					sortRows(column,"asc");
																					fillTable(mainTable.tBodies[0]);
																					$(mainTable.rows[0].cells[columnIndex[column]]).append(upArrow.clone());
																				}],
															 ["desc",function(cMenuDiv){
																					cMenuDiv.hide();
																					$(".arrow").remove();
																					sortRows(column,"desc");
																					fillTable(mainTable.tBodies[0]);
																					$(mainTable.rows[0].cells[columnIndex[column]]).append(downArrow.clone());
																				}]];
																				
		contextMenu(mainTable.rows[0].cells[columnIndex[column]],"#contextMenu",options);
}

  $(document).ready(function(){
		var mainTable = document.getElementById("mainTable");
		
		simpleHeadingMenuSetup("prefixAndCaseNumber");
		simpleHeadingMenuSetup("plaintiff");
		simpleHeadingMenuSetup("defendant");
		simpleHeadingMenuSetup("witness");
		simpleHeadingMenuSetup("charge");
		simpleHeadingMenuSetup("status");
		simpleHeadingMenuSetup("hearingDate");
		simpleHeadingMenuSetup("verdict");
		simpleHeadingMenuSetup("sentenceStatus");
		
		$("#updateDBButton").click(function(){	
			if(confirm('Are you sure?')){
				for(let i = 0; i < rowObjects.length; i++){
					console.log("SENDING CHANGES");
					rowObjects[i].sendChanges();
				}
			}
		});
		
		getDBInfo();
  
		$("#caseInfoClose").click(function(){
			$(this).parent().hide();
			$(this).siblings().children().remove();
		});
		
		$("html").click(function(){$("#contextMenu").hide();console.log("HIDE TRIGGERED");});
  });
</script>
</head>
<body>
<div id="contextMenu"></div>
<div id="caseInfo">
  <button id="caseInfoClose">Close</button>
  <div id="caseTarget"></div>
  <div id="scanTarget"></div>
</div>
<div id="currentFilters"></div>
<button style="float:right;clear:right;" onclick='window.location.href="newComplaint.php"'>Add New Complaint</button>
<button id="updateDBButton" style="float:right;clear:left;">Update Database</button>
<table id="mainTable" style="float:right; clear:both;">
<thead id="mainTableHead">
<tr>
<th>Case No.</th><th>Plaintiff(s)</th><th>Defendant</th><th>Witness(es)</th><th>Charge</th><th>Status</th><th>Hearing Date</th><th>Verdict</th><th>Sentence</th><th>Sentence Status</th>
</tr>
</thead>
<tbody>
</tbody>
</table>
</body>
</html>